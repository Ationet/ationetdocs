![ationetlogo](Content/Images/ATIOnetLogo_250x70.png)
# Ationet Fleet Mobile Payment - Wallet Implementation #

|Document Information||
|--- |--- |
|File:|ATIONet - Fleet Mobile Payment Wallet Implementation|
|Doc Version:|1.0|
|Date:|06-06-2025|
|Author:|Alexis E. Yañez|

|Change Control |||
|--- |--- |--- |
|Ver.|Date|Changes|
|1.0|06-06-2025|Initial version.|

## Contenido ##
- [Introduction](#introduction)
- [Transactional Messaging](#transactional-messaging)
  - [Pre Paid](#prepaid)
     - [Authorize](#authorize)
     - [Get Transaction](#transaction-data)
     - [Notification](#notification-prepaid)
  - [Post Paid](#postpaid)
     - [Payment Request](#payment-request)
     - [Get Transaction](#transaction-data)
     - [Notification](#notification-prepaid)
  - [Endpoint Wallet Payment Object](#endpoint-wallet-payment-object)


## Introduction
This document describes the operation to be implemented by a wallet that wants to integrate with Ationet's Fleet Mobile Payment service.


## Transactional Messaging
The following is a description of the operations that the wallet must implement to integrate with the Ationet Fleet Mobile Payment service.
As a first step, a new wallet must be registered in the Ationet environment in order to obtain the WalletId which will be used to make the request.
This new wallet will have to provide an Endpoint where to go to find the payment object in order to validate the notification sent.


### Prepaid

#### Authorize 

<b>Relative URL:</b> URLEnviroment/v{{Version}}/MPA/prepaid/{{PosId}}/{{WalletId}}/Authorize</br>
<b>Method:</b> POST </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> Allows you to generate a transaction to be processed by the PrePaid flow. 
<b>Request Body:</b>
Empty
<b>Response Body:</b>
You get an HTTP Response 200 or 400 depending on whether the request was successfully processed. 
In the case of getting an HTTP Code 200, you get:
1) The TransactionId created.
2) The information needed to process the transaction: product selection, payment notification URL, transaction creation date, flag that identifies if the request was processed correctly (IsSuccess).

```json
{
    "IsSuccess": boolean,
    "ResponseCode": string,
    "ResponseMessage": string,
    "TransactionId": guid,
    "NotificationUrl": string,
    "DateCreated": DateTime,
    "Nozzles": [
          {
            "nozzleNo": string,
            "productNo": string,
            "tankNo1": string,
            "prices": [
                {
                  "fuelUnitPrice": {
                      "value": string,
                      "currency": string
                  },
                  "priceTier": string,
                  "modeNo": string
                }
            ],
            "productCode": string
          }
    ]
}
```



#### Transaction Data
<b>Relative URL:</b> URLEnviroment/v{{Version}}/MPA/prepaid/Transaction/{transactionId}</br>
<b>Method:</b> GET </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> Allows to obtain the data of a transaction generated by Authorize
<b>Request Body:</b>
Empty
<b>Response Body:</b>
```json
{
  "id": guid,
  "siteCode": string,
  "primaryTrack": string,
  "odometer": long,
  "terminalIdentification": string,
  "transactionSequenceNumber": long,
  "state_Name": string,
  "state_Id": int,
  "paymentProcessorReferenceId": string,
  "paymentProcessorMessage": string,
  "siteSystemMessage": string,
  "fuelPointNumber": int,
  "paymentMethod": string,
  "requestedAmount": decimal,
  "authorizedAmount": decimal,
  "dispatchedAmount": decimal,
  "dispatchedQuantity": decimal?,
  "productCode": string,
  "productDescription": string,
  "productUnitPrice": decimal?,
  "unitMeasure": string,
  "createDateTime": Datetime,
  "updateDateTime": Datetime,
  "idDispatch": guid
}
```

<b>Flow:</b>
1) The wallet starts pooling after creating the transaction.
2) The wallet starts evaluating the State_Name field (or State_Id) waiting for the transaction to be in “PumpReserveAccepted” status (State_Id = 5).
3) Once the reserve is accepted, this enables the wallet to process the payment in order to continue with the flow.
4) The wallet processes the payment.
5) The wallet sends the payment notification to Ationet, of the payment already made.



#### Notification Prepaid
<b>Relative URL:</b> URLEnviroment/v{{Version}}/MPA/prepaid/Notifications/{{TransactionId}}?topic={{topic}}&id={{paymentId}}</br>
<b>Method:</b> GET </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> Allows the wallet to send the payment notification corresponding to a transaction. The PaymentId must correspond to the payment ID that Ationet will use to obtain the payment from the EndPoint provided by the wallet to validate the payment sent.
<b>Request Body:</b>
Empty
<b>Response Body:</b>
Empty


### Postpaid

#### Paymnet Request 

<b>Relative URL:</b> URLEnviroment/v{{Version}}/MPA/postpaid/{{PosId}}/{{WalletId}}/PaymentRequest</br>
<b>Method:</b> POST </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> Allows you to generate a transaction to be processed by the PostPaid flow.
<b>Request Body:</b>
Empty
<b>Response Body:</b>
You get an HTTP Response 200 or 400 depending on whether the request was successfully processed. 
In the case of getting an HTTP Code 200, you get:
1) The TransactionId created.
2) Flag that identifies if the request was successfully processed (IsSuccess).

```json
{
    "IsSuccess": boolean,
    "ResponseCode": string,
    "ResponseMessage": string,
    "TransactionId": guid
}
```



#### Transaction Data
<b>Relative URL:</b> URLAmbiente/v{{Version}}/MPA/postpaid/Transaction/{transactionId}</br>
<b>Method:</b> GET </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b>  Allows to obtain the data of a transaction generated by Authorize
<b>Request Body:</b>
Empty
<b>Response Body:</b>
```json
{
  "id": guid,
  "siteCode": string,
  "primaryTrack": string,
  "odometer": long,
  "terminalIdentification": string,
  "transactionSequenceNumber": long,
  "state_Name": string,
  "state_Id": int,
  "paymentProcessorReferenceId": string,
  "paymentProcessorMessage": string,
  "siteSystemMessage": string,
  "fuelPointNumber": int,
  "paymentMethod": string,
  "requestedAmount": decimal,
  "authorizedAmount": decimal,
  "dispatchedAmount": decimal,
  "dispatchedQuantity": decimal?,
  "productCode": string,
  "productDescription": string,
  "productUnitPrice": decimal?,
  "unitMeasure": string,
  "createDateTime": Datetime,
  "updateDateTime": Datetime,
  "idDispatch": guid
}
```
<b>Flow:</b>
1) The wallet starts pooling after the transaction is created.
2) The wallet starts to evaluate the State_Name (or State_Id) field waiting for the transaction to be “PostPaidLocked” (State_Id = 32).
3) Once the transaction is locked, this means that the SiteSystem uploaded the transaction data to Ationet, so it can be credited.
4) The wallet uses the DispatchedAmount data to process the transaction payment.
5) The wallet sends the payment notification to Ationet, of the payment already made.




#### Notification Postpaid
<b>Relative URL:</b> URLEnviroment/v{{Version}}/MPA/postpaid/Notifications/{{TransactionId}}?topic={{topic}}&id={{paymentId}}</br>
<b>Method:</b> GET </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> Allows the wallet to send the payment notification corresponding to a transaction. The PaymentId must correspond to the payment ID that Ationet will use to obtain the payment from the EndPoint provided by the wallet to validate the payment sent.
<b>Request Body:</b>
Empty
<b>Response Body:</b>
Empty



### Endpoint Wallet Payment Object
<b>Relative URL:</b> URLWalletEnviroment/{{PaymentId}}?access_token={{Access_token}}</br>
<b>Method:</b> GET </br>
<b>Input:</b> application/json </br>
<b>Output:</b> application/json </br>
<b>Use:</b> It is an Endpoint exposed by the wallet which allows to obtain the payment object. This endpoint has in its query string the value of the payment id sent in the payment notification and an Access_Token that allows authenticating the request to the wallet so that Ationet can obtain the payment object.
The Status of the payment object must be approved in case of successful payment. 

<b>Request Body:</b>
Empty

<b>Response Body:</b>
```json
{
  "id": long?,
  "externalReference": string,
  "statementDescriptor": string,
  "status": string,
  "currencyId": string,
  "dateCreated": DateTime?,
  "authCode": string,
  "transactionAmount": string,
  "collectorId": int?,
  "description": string,
  "paymentMethodId": string,
  "paymentTypeId": string,
  "product": {
        "code": null,
        "productNo": null
      }
}
```
